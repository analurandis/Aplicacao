<!DOCTYPE html>

<html>
    <head>
        
        <meta http-equiv="Access-Control-Allow-Origin" content="*" />
        <meta http-equiv="Access-Control-Allow-Headers" content="Content-Type" />
        <meta http-equiv="Access-Control-Allow-Methods" content="POST" />
        <meta http-equiv="Access-Control-Allow-Methods" content="POST" />
        <meta name="format-detection" content="telephone=no">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black" />
        <meta name="msapplication-tap-highlight" content="no">
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
        
        <link rel="stylesheet" href="css/jquery.mobile.min.css" />
        <link rel="stylesheet" href="vendor/waves/waves.min.css" />
         <link rel="stylesheet" href="vendor/wow/animate.css" />
        <link rel="stylesheet" href="css/nativedroid2.css" />
        <link rel="stylesheet" href="css/nativedroid2.color.light-blue.css" />

       
        <script src="js/index.js"></script>
        <script src="cordova.js"></script>
        <script src="js/jquery.min.js"></script>
        <script src="js/jquery-ui.min.js"></script>
        <script src="js/jquery.mobile.min.js"></script>
        <script src="vendor/waves/waves.min.js"></script>
        <script src="vendor/wow/wow.min.js"></script>
        <script src="js/nativedroid2.js"></script>
        <script src="js/script.js"></script>
        <script src="nd2settings.js"></script>
        <script src="js/core.js"></script>
        <script src="js/enc-base64.js"></script>
        <script src="js/hmac.js"></script>
        <script src="js/sha256.js"></script>
        

    </head>
    <body>

        <div data-role="page">
<!-- panel left -->
            <div data-role="panel" id="leftpanel" data-display="overlay" data-position-fixed="true" >

                <div class='nd2-sidepanel-profile wow fadeInDown'>
                    <img class='profile-background' src="img/logo.png">
                    <div class="row">
                        <div class='col-xs-4 center-xs'>
                            <div class='box'>
                                <img class="profile-thumbnail" src="img/logo.png" />
                            </div>
                        </div>
                        <div class='col-xs-8'>
                            <div class='box profile-text'>
                                <strong>Empresa</strong>
                                <span class='subline'>Usuário</span>
                            </div>
                        </div>
                    </div>
                </div>


                <ul data-role="listview" data-inset="false">
                    <li data-role="list-divider">Elements</li>
                </ul>
                <div data-role="collapsible" data-inset="false"  data-collapsed-icon="carat-d" data-expanded-icon="carat-d" data-iconpos="right">
                    <h3>Basic Elements</h3>
                    <ul data-role="listview" data-inset="false" data-icon="false">
                        <li><a href="/examples/elements/text.html" data-ajax='false' data-icon="false">Text Elements</a></li>
                        
                    </ul>
                </div>
                <div data-role="collapsible" data-inset="false" data-collapsed-icon="carat-d" data-expanded-icon="carat-d" data-iconpos="right">
                    <h3>Extended Elements</h3>
                    <ul data-role="listview" data-icon="false">
                        <li><a href="/examples/extended/tabs.html" data-ajax='false'>Tabs</a></li>
                    </ul>
                </div>
                <ul data-role="listview" data-inset="false">
                    <li data-role="list-divider">Layouts</li>
                </ul>
                <div data-role="collapsible" data-inset="false" data-collapsed-icon="carat-d" data-expanded-icon="carat-d" data-iconpos="right">
                    <h3>Real-World-Examples</h3>
                    <ul data-role="listview" data-icon="false">
                        <li><a href="/examples/pages/profile.html" class="ui-disabled" data-ajax='false'>Profile</a></li>
                    </ul>
                </div>
                <hr class="inset">
                <ul data-role="listview" data-inset="false">
                    <li data-role="list-divider">Information</li>
                </ul>
                <div data-role="collapsible" data-inset="false" data-collapsed-icon="carat-d" data-expanded-icon="carat-d" data-iconpos="right">
                    <h3>Nice to Know</h3>
                    <ul data-role="listview" data-icon="false">
                        <li><a href="/info/colors_and_styles.html" data-ajax='false'>Colors &amp; Styles</a></li>
                        <li><a href="/info/credits.html" data-ajax='false'>Credits &amp; License</a></li>
                    </ul>
                </div>
            </div>
<!-- /panel left -->

<!-- nav bar -->
            <div data-role="header" data-position="fixed" class="wow fadeInDown" data-wow-delay="0.2s">
                <a href="#leftpanel" class="ui-btn ui-btn-left wow fadeIn" data-wow-delay='0.8s'><i class="zmdi zmdi-menu"></i></a>
                <h1 class="wow fadeIn BarraAcima" data-wow-delay='0.4s'>Login</h1>
            </div>
<!-- nav bar -->

<!-- TELA LOGIN GERAR TOKEN-->

            <div role="main" class="ui-content TelaLoginToken" data-inset="false" >
                <br>
                <div align="center"> 
                    <img class='profile-background' src="img/logo.png">
                </div>
                <br>

                <label>Login</label>
                <input id="login_field" name="login_field" type="text"  />
                <label>Senha</label>
                <input id="senha_field" name="senha_field" type="password" />
                <br>
                <button class=" ui-btn ui-btn-b" onclick="cadastrarToken()">Login</button>
              </div>
<!-- TELA LOGIN GERAR TOKEN-->
<!-- TELA LOGIN -->
            <div role="main" class="ui-content TelaLogin" data-inset="false" >
                <br>
                <div align="center"> 
                    <img class='profile-background' src="img/logo.png">
                </div>
                <br>
                <label>Login</label>
                <input id="login_field2" name="login_field" type="text"  />
                <label>Senha</label>
                <input id="senha_field2" name="senha_field" type="password" />
                <br>
                <button class="ui-input-btn ui-btn ui-btn-b" onclick="logar()">Login </button>
            </div>
<!-- TELA LOGIN -->
            <div class="sucesso">
                <p>Pagina Inicial</p>
                <p class="retorno"></p>
                 <p class="retorno2"></p>
              </div>
            </div>
     
        <script type="text/javascript">
            function getBase64Encode(rawStr){
                var wordArray = CryptoJS.enc.Utf8.parse(JSON.stringify(rawStr));
                var result = CryptoJS.enc.Base64.stringify(wordArray);
                return result;
            };
             
             function getBase64Decode(rawStr){
                var wordArray =CryptoJS.enc.Base64.parse(rawStr);
                var result = wordArray.toString(CryptoJS.enc.Utf8);
                return result
            };
            
            function cadastrarToken()
            {
                var login_field_value=$("#login_field").val();
                var senha_field_value=$("#senha_field").val();
                var header = {
                    "alg": "HS256",
                    "typ": "JWT"};
                var payload ={
                    "uuid": device.uuid,
                    "model":device.model,
                    "platform":device.platform
                };
                var headerBase64 = getBase64Encode(header);
                var payloadBase64 = getBase64Encode(payload);
                var signature=CryptoJS.HmacSHA256(headerBase64 +"."+ payloadBase64 , senha_field_value)
                var signatureBase64 = CryptoJS.enc.Base64.stringify(signature);
                var jwt = headerBase64 + "." +payloadBase64+"."+signatureBase64;

                var JSONdata = {
                    "login":login_field_value,
                    "senha":senha_field_value,
                    "jwt": jwt
                };
                alert(JSON.stringify(JSONdata));
                
                $.ajax({
                type: "post",
                url: "http://192.168.0.10//Usuarios/CadastrarDispositivo", 
                data: { 'token': JSONdata },         
                dataType: "json", 
                success: function(resultado){  
                    if(resultado["retorno"]=="Senha ou usuário inválido"){
                        alert(resultado["retorno"]);
                     };
                      if(resultado["retorno"]=="Token Inválido"){
                        alert(resultado["retorno"]);
                     };
                    if(resultado["retorno"]=="Login realizado com sucesso"){
                        $(".TelaLoginToken").hide();
                        $(".BarraAcima").html('Pagina Inicial');
                        var storage = window.localStorage;
                        alert(JSONdata['jwt']);
                        var storage = window.localStorage;
                        var token = JSONdata['jwt'];
                        storage.setItem('token', token ); 

                    };                  
                 },
                error: function(XMLHttpRequest, textStatus, errorThrown) { 
                    alert("Status: " + textStatus); alert("Error: " + errorThrown); 
                } 
          
            });
            }
 
            function logar()
            {
                var login_field_value=$("#login_field2").val();
                var senha_field_value=$("#senha_field2").val();
                /*var header = {
                    "header":{
                        "alg": "HS256",
                        "typ": "JWT"
                    }
                };
                var payload ={
                    "payload":{
                        "uuid": device.uuid,
                        "model":device.model,
                        "platform":device.platform
                    }
                };
                var headerBase64 = getBase64Encode(header);
                var payloadBase64 = getBase64Encode(payload);
                var signature=CryptoJS.HmacSHA256(headerBase64 +"."+ payloadBase64 , senha_field_value)
                var signatureBase64 = CryptoJS.enc.Base64.stringify(signature);
                var jwt = headerBase64 + "." +payloadBase64+"."+signatureBase64;
                */
                var storage = window.localStorage;
                var jwt = storage.getItem('token');
                alert(jwt);
                var JSONdata = {
                    "login":login_field_value,
                    "senha":senha_field_value,
                    "jwt": jwt,
                };

                alert(JSON.stringify(JSONdata));
                $.ajax({
                type: "post",
                url: "http://192.168.0.10//Usuarios/ValidarUsuario", 
                data: { 'dados': JSONdata },         
                dataType: "json", 
                success: function(resultado){ 
                    if(resultado["retorno"]=="Senha ou usuário inválido"){
                        alert(resultado["retorno"]);
                     };
                    if(resultado["retorno"]=="Token Inválido"){
                        alert(resultado["retorno"]);
                     };
                    if(resultado["retorno"]=="Login realizado com sucesso"){
                        $(".TelaLogin").hide(); 
                        $(".BarraAcima").html('Pagina Inicial');

                    };
                    
                   
                   
                                      
                 },
                error: function(XMLHttpRequest, textStatus, errorThrown) { 
                    alert("Status: " + textStatus); alert("Error: " + errorThrown); 
                } 
          
            });
        }
         
         

        </script>

    </body>
</html>
